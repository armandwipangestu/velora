name: Release & Deploy

on:
    push:
        branches:
            - staging
            - main

env:
    GHCR: ghcr.io/armandwipangestu/velora
    DOCKERHUB_IMAGE: devvnull/velora

jobs:
    # ------------------------------------------------------
    # JOB 1 - BUILD DOCKER IMAGE USING COMMIT SHA (HASH)
    # ------------------------------------------------------
    build-docker-sha:
        name: Build Docker Image Using Commit SHA
        runs-on: ubuntu-latest
        permissions:
            contents: write
            issues: write
            pull-requests: write
        environment: ${{ github.ref_name }}
    
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
    
            - name: Extract commit SHA
              id: sha
              run: echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
    
            - name: Log in to GitHub Container Registry
              run: echo "${{ secrets.GH_TOKEN }}" | docker login ghcr.io -u "${{ secrets.GH_USERNAME }}" --password-stdin

            - name: Log in to Docker Hub
              run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
    
            - name: Build Docker Image with SHA tag
              run: |
                  docker build \
                    --platform linux/amd64 \
                    -f Dockerfile \
                    --build-arg NEXT_PUBLIC_APP_URL=${{ secrets.NEXT_PUBLIC_APP_URL }} \
                    --build-arg NEXT_PUBLIC_GISCUS_REPO=${{ secrets.NEXT_PUBLIC_GISCUS_REPO }} \
                    --build-arg NEXT_PUBLIC_GISCUS_REPO_ID=${{ secrets.NEXT_PUBLIC_GISCUS_REPO_ID }} \
                    --build-arg NEXT_PUBLIC_GISCUS_CATEGORY=${{ secrets.NEXT_PUBLIC_GISCUS_CATEGORY }} \
                    --build-arg NEXT_PUBLIC_GISCUS_CATEGORY_ID=${{ secrets.NEXT_PUBLIC_GISCUS_CATEGORY_ID }} \
                    --build-arg NEXT_PUBLIC_GISCUS_MAPPING=${{ secrets.NEXT_PUBLIC_GISCUS_MAPPING }} \
                    --build-arg NEXT_PUBLIC_GISCUS_TERM=${{ secrets.NEXT_PUBLIC_GISCUS_TERM }} \
                    --build-arg NEXT_PUBLIC_UMAMI_DATA_WEBSITE_ID=${{ secrets.NEXT_PUBLIC_UMAMI_DATA_WEBSITE_ID }} \
                    --build-arg NEXT_PUBLIC_GA_MEASUREMENT_ID=${{ secrets.NEXT_PUBLIC_GA_MEASUREMENT_ID }} \
                    -t $GHCR:${{ env.SHORT_SHA }} \
                    -t $DOCKERHUB_IMAGE:${{ env.SHORT_SHA }} .
    
            - name: Push Docker Image (SHA tag)
              run: |
                  docker push $GHCR:${{ env.SHORT_SHA }}
                  docker push $DOCKERHUB_IMAGE:${{ env.SHORT_SHA }}
    
            - name: Save SHA to file
              run: echo "${SHORT_SHA}" > sha.txt
    
            - name: Upload SHA artifact
              uses: actions/upload-artifact@v4
              with:
                  name: built-sha
                  path: sha.txt

    # ------------------------------------------------------
    # JOB 2 - SEMANTIC RELEASE
    # ------------------------------------------------------
    release-and-tagging-version:
        name: Release and Tagging Version
        runs-on: ubuntu-latest
        # needs: build-docker-sha
        permissions:
            contents: write
            issues: write
            pull-requests: write
        environment: ${{ github.ref_name }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Bun for Semantic Release
              uses: oven-sh/setup-bun@v2
              with:
                bun-version: "latest"

            - name: Restore Bun Cache
              uses: actions/cache@v4
              with:
                path: |
                  ~/.bun/install/cache
                  node_modules
                key: ${{ runner.os }}-bun-${{ hashFiles('bun.lockb') }}
                restore-keys: |
                  ${{ runner.os }}-bun-

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Run semantic-release
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  NPM_TOKEN: false
              run: bunx semantic-release

            - name: Upload version.txt artifact
              uses: actions/upload-artifact@v4
              with:
                  name: release-version
                  path: version.txt

    # ------------------------------------------------------
    # JOB 3 - RETAG IMAGE: SHA -> VERSION -> LATEST
    # ------------------------------------------------------
    retag-and-push:
        name: Retag and Push Docker Image
        runs-on: ubuntu-latest
        needs:
            - build-docker-sha
            - release-and-tagging-version
        permissions:
            contents: write
            issues: write
            pull-requests: write
            packages: write
        environment: ${{ github.ref_name }}
    
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
    
            - name: Download version.txt artifact
              uses: actions/download-artifact@v4
              with:
                  name: release-version
              continue-on-error: true # Prevents crash if no release happened
    
            - name: Check if version exists
              id: check-version
              run: |
                  if [ -f "version.txt" ]; then
                      echo "VERSION=$(cat version.txt)" >> $GITHUB_ENV
                      echo "RELEASE_EXISTS=true" >> $GITHUB_OUTPUT
                  else
                      echo "No new version released. Skipping retag."
                      echo "RELEASE_EXISTS=false" >> $GITHUB_OUTPUT
                  fi
    
            - name: Download sha.txt artifact
              if: steps.check-version.outputs.RELEASE_EXISTS == 'true'
              uses: actions/download-artifact@v4
              with:
                  name: built-sha
    
            - name: Set SHORT_SHA env
              if: steps.check-version.outputs.RELEASE_EXISTS == 'true'
              run: echo "SHORT_SHA=$(cat sha.txt)" >> $GITHUB_ENV
    
            - name: Log in to GitHub Container Registry
              if: steps.check-version.outputs.RELEASE_EXISTS == 'true'
              run: echo "${{ secrets.GH_TOKEN }}" | docker login ghcr.io -u "${{ secrets.GH_USERNAME }}" --password-stdin

            - name: Log in to Docker Hub
              if: steps.check-version.outputs.RELEASE_EXISTS == 'true'
              run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
    
            - name: Retag and Push
              if: steps.check-version.outputs.RELEASE_EXISTS == 'true'
              run: |
                  # Pull from GHCR (using the SHA pushed in Job 1)
                  docker pull --platform linux/amd64 $GHCR_IMAGE:${{ env.SHORT_SHA }}

                  # Retag and Push to GHCR
                  docker tag $GHCR_IMAGE:${{ env.SHORT_SHA }} $GHCR_IMAGE:${{ env.VERSION }}
                  docker push $GHCR_IMAGE:${{ env.VERSION }}

                  # Retag and Push to Docker Hub
                  docker tag $GHCR_IMAGE:${{ env.SHORT_SHA }} $DOCKERHUB_IMAGE:${{ env.VERSION }}
                  docker push $DOCKERHUB_IMAGE:${{ env.VERSION }}
    
            - name: Retag latest (only on main)
              if: steps.check-version.outputs.RELEASE_EXISTS == 'true' && github.ref_name == 'main'
              run: |
                  docker tag $GHCR:${{ env.VERSION }} $GHCR:latest
                  docker tag $GHCR_IMAGE:${{ env.VERSION }} $DOCKERHUB_IMAGE:latest
                  docker push $GHCR:latest
                  docker push $DOCKERHUB_IMAGE:latest